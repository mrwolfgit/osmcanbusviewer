<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OSM CAN Bus Viewer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body class="bg-slate-50">
  <div class="p-6 max-w-6xl mx-auto">
    <h1 class="text-2xl font-bold mb-4">OSM CAN Bus Viewer</h1>

    <div class="mb-4 flex flex-col sm:flex-row gap-4 items-start sm:items-center">
      <label class="cursor-pointer px-4 py-2 bg-slate-800 text-white rounded">
        Choose .TXT file
        <input id="fileInput" type="file" accept=".txt,.log,.csv" class="hidden" />
      </label>
      <div class="text-sm text-slate-600">Upload your CAN log file with fields like: Date | Time(ms) | CAN ID | Length | Data</div>
      <div id="errorBox" class="text-sm text-red-600 hidden"></div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="md:col-span-1">
        <div class="bg-white border rounded p-3 shadow-sm">
          <h2 class="font-semibold">Found CAN IDs</h2>
          <div id="idsList" class="mt-2 text-sm text-slate-500">No frames parsed yet.</div>
        </div>
      </div>

      <div class="md:col-span-2">
        <div class="bg-white border rounded p-3 shadow-sm">
          <h2 class="font-semibold">Message Frequency</h2>
          <div><canvas id="freqChart" height="300"></canvas></div>

          <h3 class="mt-4 font-semibold">Recent Frames (max 200)</h3>
          <div class="overflow-auto max-h-72 mt-2">
            <table class="w-full text-left text-sm">
              <thead class="sticky top-0 bg-white">
                <tr>
                  <th class="p-2">Time</th>
                  <th class="p-2">ID</th>
                  <th class="p-2">Bytes</th>
                  <th class="p-2">Raw</th>
                </tr>
              </thead>
              <tbody id="framesTbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  let ALL_FRAMES = [];
  let GROUPS = [];
  let SELECTED_ID = null;
  let chartInstance = null;

  const $ = (sel) => document.querySelector(sel);

  const fmtIso = (ms) => new Date(ms).toISOString();

  function showError(msg) {
    const box = $('#errorBox');
    box.textContent = msg;
    box.classList.toggle('hidden', !msg);
  }

  // âœ… Updated for your format
  function parseData(text) {
    const lines = text.split(/\\r?\\n/);
    const frames = [];

    lines.forEach(line => {
      const parts = line.split('|').map(p => p.trim());
      if (parts.length !== 5 || parts[0] === "Date") return;

      const [date, timeMs, canId, length, data] = parts;
      const ts = new Date(date).getTime() + parseInt(timeMs, 10);
      const id = canId.startsWith("0x") ? canId.toLowerCase() : "0x" + canId;
      const bytes = data.split(/\\s+/).map(b => b.toUpperCase());

      frames.push({ ts, id, bytes, raw: line });
    });

    return frames;
  }

  function groupById(frames) {
    const map = new Map();
    frames.forEach(f => {
      const key = f.id;
      if (!map.has(key)) map.set(key, []);
      map.get(key).push(f);
    });
    return Array.from(map.entries()).map(([id, arr]) => ({ id, count: arr.length, frames: arr }));
  }

  function buildIdsList() {
    const host = $('#idsList');
    host.innerHTML = '';
    if (GROUPS.length === 0) {
      host.innerHTML = '<div class="text-slate-500">No frames parsed yet.</div>';
      return;
    }

    const ul = document.createElement('ul');
    ul.className = 'divide-y';
    GROUPS.forEach(it => {
      const li = document.createElement('li');
      li.className = `py-2 flex justify-between items-center ${SELECTED_ID === it.id ? 'bg-slate-100' : ''}`;

      const btn = document.createElement('button');
      btn.innerHTML = `<div class="font-mono">${it.id}</div><div class="text-xs text-slate-500">${it.count} frames</div>`;
      btn.onclick = () => { SELECTED_ID = it.id; updateDisplay(); };

      const copyBtn = document.createElement('button');
      copyBtn.className = 'text-xs px-2 py-1 border rounded';
      copyBtn.textContent = 'Copy';
      copyBtn.onclick = () => {
        const sample = it.frames.slice(0,5).map(f => f.raw).join('\\n');
        navigator.clipboard.writeText(sample);
        alert(`Copied sample lines for ID ${it.id}`);
      };

      li.append(btn, copyBtn);
      ul.appendChild(li);
    });
    host.appendChild(ul);
  }

  function buildChart(frames) {
    const buckets = new Map();
    frames.forEach(f => {
      const s = Math.floor(f.ts / 1000);
      buckets.set(s, (buckets.get(s) || 0) + 1);
    });
    const sorted = [...buckets.entries()].sort((a,b) => a[0]-b[0]);
    const labels = sorted.map(([s]) => new Date(s*1000).toISOString());
    const values = sorted.map(([,c]) => c);

    const ctx = document.getElementById('freqChart');
    if (chartInstance) chartInstance.destroy();
    chartInstance = new Chart(ctx, {
      type: 'line',
      data: { labels, datasets: [{ label: 'Messages/s', data: values, borderWidth: 2, tension: 0.25 }] },
      options: { scales: { y: { beginAtZero: true } } }
    });
  }

  function buildTable(frames) {
    const tbody = $('#framesTbody');
    tbody.innerHTML = '';
    frames.slice().reverse().slice(0,200).forEach(f => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="p-2 font-mono text-xs">${fmtIso(f.ts)}</td>
        <td class="p-2 font-mono">${f.id}</td>
        <td class="p-2 font-mono text-xs">${f.bytes.join(' ')}</td>
        <td class="p-2 text-xs">${f.raw}</td>`;
      tbody.appendChild(tr);
    });
  }

  function updateDisplay() {
    const frames = ALL_FRAMES.filter(f => f.id === SELECTED_ID);
    buildChart(frames);
    buildTable(frames);
    buildIdsList();
  }

  $('#fileInput').addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    showError('');
    const reader = new FileReader();
    reader.onload = ev => {
      ALL_FRAMES = parseData(ev.target.result);
      GROUPS = groupById(ALL_FRAMES);
      SELECTED_ID = GROUPS[0]?.id;
      updateDisplay();
    };
    reader.readAsText(file);
  });
</script>
</body>
</html>
